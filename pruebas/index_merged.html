<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>APEX ROBOT ID QR</title>

    <!-- ✅ QR engine estable -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.js"></script>

    <!-- ✅ Supabase JS (sin login por ahora) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg: #070A10;
            --panel: #0B1020;
            --panel2: #0C142A;
            --stroke: rgba(122, 63, 255, .55);
            --neon: #7A3FFF;
            --neon2: #2FE6FF;
            --hot: #FF2E88;
            --text: #EAF0FF;
            --muted: rgba(234, 240, 255, .65);
            --good: #2FE6FF;
            --warn: #FFB020;
            --bad: #FF2E88;
            --r: 16px;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
            color: var(--text);
            background:
                radial-gradient(1100px 700px at 10% -10%, rgba(122, 63, 255, .25), transparent 60%),
                radial-gradient(900px 600px at 110% 0%, rgba(47, 230, 255, .18), transparent 55%),
                radial-gradient(900px 700px at 50% 120%, rgba(255, 46, 136, .10), transparent 55%),
                var(--bg);
        }

        .wrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 18px
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin: 6px 0 14px;
            flex-wrap: wrap;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border: 1px solid rgba(122, 63, 255, .35);
            background: linear-gradient(180deg, rgba(11, 16, 32, .85), rgba(12, 20, 42, .55));
            border-radius: 999px;
            box-shadow: 0 0 0 1px rgba(47, 230, 255, .08) inset;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: conic-gradient(from 210deg, var(--neon), var(--neon2), var(--hot), var(--neon));
            filter: drop-shadow(0 0 10px rgba(122, 63, 255, .6));
        }

        .brand span {
            font-weight: 800;
            letter-spacing: .6px
        }

        .badge {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid rgba(47, 230, 255, .25);
            background: rgba(12, 20, 42, .55);
            color: var(--muted);
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .badge b {
            color: var(--text)
        }

        .grid {
            display: grid;
            grid-template-columns: 1.15fr .85fr;
            gap: 14px;
            align-items: start;
        }

        @media (max-width: 980px) {
            .grid {
                grid-template-columns: 1fr
            }
        }

        .panel {
            border-radius: calc(var(--r) + 6px);
            background: linear-gradient(180deg, rgba(11, 16, 32, .92), rgba(12, 20, 42, .68));
            border: 1px solid rgba(122, 63, 255, .35);
            box-shadow: 0 0 0 1px rgba(47, 230, 255, .08) inset, 0 18px 60px rgba(0, 0, 0, .55);
            overflow: hidden;
        }

        .panelHead {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
            border-bottom: 1px solid rgba(122, 63, 255, .25);
        }

        .panelHead h2 {
            margin: 0;
            font-size: 14px;
            letter-spacing: .6px;
            text-transform: uppercase;
            color: var(--muted);
        }

        .panelHead .title {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .panelHead .title b {
            font-size: 18px;
            color: var(--text);
            letter-spacing: .2px
        }

        .btnRow {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .btn {
            border: 1px solid rgba(47, 230, 255, .25);
            background: rgba(12, 20, 42, .55);
            color: var(--text);
            padding: 10px 12px;
            border-radius: 14px;
            font-weight: 800;
            letter-spacing: .2px;
            cursor: pointer;
        }

        .btn:hover {
            filter: brightness(1.08)
        }

        .btn.primary {
            border-color: rgba(122, 63, 255, .45);
            background: linear-gradient(90deg, rgba(122, 63, 255, .28), rgba(47, 230, 255, .10));
            box-shadow: 0 0 0 1px rgba(122, 63, 255, .12) inset;
        }

        .btn.hot {
            border-color: rgba(255, 46, 136, .45);
            background: rgba(255, 46, 136, .10);
        }

        .content {
            padding: 16px
        }

        .sectionTitle {
            margin: 12px 0 10px;
            color: rgba(234, 240, 255, .55);
            font-size: 12px;
            letter-spacing: .8px;
            text-transform: uppercase;
        }

        .formGrid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px
        }

        @media (max-width: 700px) {
            .formGrid {
                grid-template-columns: 1fr
            }
        }

        label {
            display: block;
            font-size: 12px;
            color: rgba(234, 240, 255, .60);
            margin: 4px 0 6px
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 12px 12px;
            border-radius: 14px;
            border: 1px solid rgba(122, 63, 255, .22);
            background: rgba(7, 10, 16, .35);
            color: var(--text);
            outline: none;
        }

        textarea {
            min-height: 80px;
            resize: vertical
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: rgba(47, 230, 255, .35);
            box-shadow: 0 0 0 1px rgba(47, 230, 255, .10) inset;
        }

        .hint {
            color: rgba(234, 240, 255, .45);
            font-size: 12px;
            line-height: 1.35;
            margin-top: 10px
        }

        .rightBox {
            padding: 16px
        }

        .qrBox {
            border-radius: 18px;
            border: 1px solid rgba(47, 230, 255, .22);
            background: rgba(7, 10, 16, .35);
            padding: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 360px;
        }

        .qrCard {
            margin-top: 12px;
            border-radius: 16px;
            border: 1px solid rgba(122, 63, 255, .25);
            background: linear-gradient(180deg, rgba(11, 16, 32, .86), rgba(12, 20, 42, .58));
            padding: 12px;
        }

        .kv {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 6px 10px;
            align-items: center;
            font-size: 13px
        }

        .k {
            color: rgba(234, 240, 255, .60)
        }

        .v {
            color: var(--text);
            font-weight: 700
        }

        .chipRow {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px
        }

        .chip {
            padding: 7px 10px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid rgba(122, 63, 255, .28);
            background: rgba(7, 10, 16, .35);
            color: var(--muted);
        }

        .chip.good {
            border-color: rgba(47, 230, 255, .55);
            color: var(--text)
        }

        .chip.warn {
            border-color: rgba(255, 176, 32, .55);
            color: var(--text)
        }

        .chip.bad {
            border-color: rgba(255, 46, 136, .55);
            color: var(--text)
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            font-size: 12px;
            color: rgba(234, 240, 255, .70);
            white-space: pre-wrap;
            word-break: break-word;
            background: rgba(7, 10, 16, .35);
            border: 1px solid rgba(122, 63, 255, .18);
            border-radius: 14px;
            padding: 10px;
            margin-top: 10px;
        }

        /* Viewer mode */
        .viewer {
            display: none;
            padding: 18px;
        }

        .viewer .bigTitle {
            font-size: 22px;
            margin: 0 0 8px;
            font-weight: 900;
            letter-spacing: .2px
        }

        .viewer .sub {
            color: rgba(234, 240, 255, .65);
            margin-bottom: 14px
        }

        .viewerGrid {
            display: grid;
            grid-template-columns: 1.2fr .8fr;
            gap: 14px;
        }

        @media (max-width: 900px) {
            .viewerGrid {
                grid-template-columns: 1fr
            }
        }

        .mediaBox {
            border-radius: 18px;
            border: 1px solid rgba(47, 230, 255, .22);
            background: rgba(7, 10, 16, .35);
            overflow: hidden;
            min-height: 220px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .mediaBox img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none
        }

        .fallback {
            color: rgba(234, 240, 255, .35);
            font-weight: 900;
            letter-spacing: .8px
        }

        /* =========================
       ✅ DASHBOARD + LISTS
       ========================= */
        .hidden {
            display: none !important;
        }

        .heroGrid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        @media (max-width: 980px) {
            .heroGrid {
                grid-template-columns: 1fr;
            }
        }

        .heroCard {
            border-radius: 18px;
            border: 1px solid rgba(47, 230, 255, .18);
            background:
                radial-gradient(700px 220px at 0% 0%, rgba(47, 230, 255, .10), transparent 55%),
                radial-gradient(700px 220px at 100% 0%, rgba(255, 46, 136, .08), transparent 55%),
                rgba(7, 10, 16, .25);
            padding: 16px;
            cursor: pointer;
            transition: filter .12s ease, transform .12s ease;
            min-height: 110px;
        }

        .heroCard:hover {
            filter: brightness(1.07);
            transform: translateY(-1px);
        }

        .heroCard b {
            font-size: 18px;
            display: block;
            margin-top: 6px;
        }

        .heroCard .mut {
            color: rgba(234, 240, 255, .60);
            font-size: 12px;
            margin-top: 8px;
            line-height: 1.35;
        }

        .statsGrid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        @media (max-width: 700px) {
            .statsGrid {
                grid-template-columns: 1fr;
            }
        }

        .statBox {
            border-radius: 18px;
            border: 1px solid rgba(122, 63, 255, .22);
            background: rgba(7, 10, 16, .25);
            padding: 14px;
        }

        .statBox .lbl {
            color: rgba(234, 240, 255, .60);
            font-size: 12px;
            letter-spacing: .6px;
            text-transform: uppercase;
        }

        .statBox .val {
            font-size: 30px;
            font-weight: 900;
            margin-top: 6px;
        }

        .searchRow {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            padding: 12px;
            border-radius: 18px;
            border: 1px solid rgba(47, 230, 255, .18);
            background: rgba(7, 10, 16, .25);
        }

        .searchRow input {
            flex: 1 1 240px;
        }

        .list {
            border-radius: 18px;
            border: 1px solid rgba(122, 63, 255, .22);
            overflow: hidden;
            background: rgba(7, 10, 16, .18);
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 12px 14px;
            border-top: 1px solid rgba(122, 63, 255, .18);
        }

        .row:first-child {
            border-top: none;
        }

        .row:hover {
            background: rgba(122, 63, 255, .07);
        }

        .row .left {
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .row .left b {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .row .left span {
            color: rgba(234, 240, 255, .60);
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .row .right {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 0 0 auto;
        }

        /* =========================
   ✅ TOURNAMENTS (scoped)
   ========================= */
        #tournamentsPanel .btn.ghost {
            background: transparent;
        }

        #tournamentsPanel .tGrid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            align-items: start;
        }

        @media (max-width: 1100px) {
            #tournamentsPanel .tGrid {
                grid-template-columns: 1fr;
            }
        }

        #tournamentsPanel .tMiniGrid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media (max-width: 700px) {
            #tournamentsPanel .tMiniGrid {
                grid-template-columns: 1fr;
            }
        }

        /* Bracket */
        #tournamentsPanel .bracketWrap {
            overflow: auto;
            border-radius: 18px;
            border: 1px solid rgba(47, 230, 255, .18);
            background: rgba(7, 10, 16, .22);
            padding: 14px;
            min-height: 440px;
        }

        #tournamentsPanel .bracket {
            display: flex;
            gap: 18px;
            align-items: flex-start;
            min-width: 980px;
        }

        #tournamentsPanel .round {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-width: 260px;
        }

        #tournamentsPanel .roundTitle {
            font-size: 12px;
            letter-spacing: .8px;
            text-transform: uppercase;
            color: rgba(234, 240, 255, .55);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #tournamentsPanel .match {
            border-radius: 16px;
            border: 1px solid rgba(122, 63, 255, .22);
            background: linear-gradient(180deg, rgba(11, 16, 32, .86), rgba(12, 20, 42, .55));
            padding: 10px;
        }

        #tournamentsPanel .slot {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 14px;
            border: 1px solid rgba(47, 230, 255, .16);
            background: rgba(7, 10, 16, .22);
            margin-top: 8px;
        }

        #tournamentsPanel .slot:first-child {
            margin-top: 0;
        }

        #tournamentsPanel .slot .name {
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        #tournamentsPanel .slot .name b {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 13px;
        }

        #tournamentsPanel .slot .name span {
            color: rgba(234, 240, 255, .55);
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #tournamentsPanel .score {
            width: 56px;
            text-align: center;
            padding: 8px 8px;
            border-radius: 12px;
            border: 1px solid rgba(122, 63, 255, .22);
            background: rgba(0, 0, 0, .12);
            color: var(--text);
            font-weight: 900;
        }

        #tournamentsPanel .win {
            border-color: rgba(47, 230, 255, .45) !important;
            box-shadow: 0 0 0 1px rgba(47, 230, 255, .10) inset;
        }

        /* Groups */
        #tournamentsPanel .groupsWrap {
            border-radius: 18px;
            border: 1px solid rgba(47, 230, 255, .18);
            background: rgba(7, 10, 16, .22);
            padding: 14px;
        }

        #tournamentsPanel .groupsGrid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        @media (max-width: 1100px) {
            #tournamentsPanel .groupsGrid {
                grid-template-columns: 1fr;
            }
        }

        #tournamentsPanel .groupCard {
            border-radius: 16px;
            border: 1px solid rgba(122, 63, 255, .22);
            background: rgba(0, 0, 0, .12);
            padding: 12px;
        }

        #tournamentsPanel .groupCard h3 {
            margin: 0 0 8px;
            font-size: 12px;
            letter-spacing: .8px;
            text-transform: uppercase;
            color: rgba(234, 240, 255, .55);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #tournamentsPanel .groupLine {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 14px;
            border: 1px solid rgba(47, 230, 255, .14);
            background: rgba(7, 10, 16, .18);
            margin-top: 8px;
            font-size: 13px;
        }

        #tournamentsPanel .groupLine:first-child {
            margin-top: 0;
        }

        #tournamentsPanel .groupLine span {
            color: rgba(234, 240, 255, .55);
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 55%;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="topbar">
            <div class="brand">
                <div class="dot"></div><span>APEX ROBOT ID QR</span>
            </div>

            <div class="badge">
                <b id="modeBadge">dashboard</b>
                · GitHub Pages + Supabase
                <span id="miniStatus" style="opacity:.9;"></span>
            </div>
        </div>

        <!-- =========================
         ✅ DASHBOARD
         ========================= -->
        <section id="dashboard" class="panel">
            <div class="panelHead">
                <div class="title">
                    <h2>Pantalla principal</h2>
                    <b>MiniSumo Robot Dashboard</b>
                </div>
                <div class="btnRow">
                    <button class="btn primary" id="goRegister">Registrar Robot</button>
                    <button class="btn" id="goMine">Mis Robots</button>
                    <button class="btn" id="goTournaments">Torneos</button>
                    <button class="btn hot" id="refreshDash">Actualizar</button>
                </div>
            </div>

            <div class="content">
                <div class="heroGrid">
                    <div class="heroCard" id="cardHome">
                        <div class="chip good">Inicio</div>
                        <b>Dashboard</b>
                        <div class="mut">Estadísticas, búsqueda rápida y últimos robots.</div>
                    </div>

                    <div class="heroCard" id="cardNew">
                        <div class="chip warn">Nuevo</div>
                        <b>Registrar Robot</b>
                        <div class="mut">Usa tu generador actual (offline o link) y guarda en Supabase.</div>
                    </div>

                    <div class="heroCard" id="cardMine">
                        <div class="chip">Lista</div>
                        <b>Mis Robots</b>
                        <div class="mut">Robots que tú registraste desde este navegador (sin login).</div>
                    </div>
                </div>

                <div class="sectionTitle">Estadísticas</div>
                <div class="statsGrid">
                    <div class="statBox">
                        <div class="lbl">Robots registrados</div>
                        <div class="val" id="statTotal">—</div>
                    </div>
                    <div class="statBox">
                        <div class="lbl">Registrados hoy</div>
                        <div class="val" id="statToday">—</div>
                    </div>
                    <div class="statBox">
                        <div class="lbl">Mis robots</div>
                        <div class="val" id="statMine">—</div>
                    </div>
                </div>

                <div class="sectionTitle">Buscar robot (por Robot ID)</div>
                <div class="searchRow">
                    <input id="searchRid" placeholder="Ej. MS-014" />
                    <button class="btn primary" id="btnSearchRid">Abrir</button>
                </div>

                <div class="sectionTitle">Últimos robots (Supabase)</div>
                <div class="list" id="latestList">
                    <div class="row">
                        <div class="left"><b>Cargando…</b><span>—</span></div>
                    </div>
                </div>

                <div class="hint" style="margin-top:12px">
                    Tip: El QR “link” apunta a <b>#id=ROBOT_ID</b> y por eso el viewer abre desde Supabase.
                </div>
            </div>
        </section>

        <div style="height:14px;"></div>

        <!-- =========================
         ✅ MIS ROBOTS (SIN LOGIN)
         ========================= -->
        <section id="minePanel" class="panel hidden">
            <div class="panelHead">
                <div class="title">
                    <h2>Robots del dispositivo</h2>
                    <b>Mis Robots</b>
                </div>
                <div class="btnRow">
                    <button class="btn" id="backFromMine">Volver</button>
                    <button class="btn primary" id="reloadMine">Actualizar</button>
                    <button class="btn hot" id="clearMine">Borrar lista local</button>
                </div>
            </div>

            <div class="content">
                <div class="sectionTitle">Buscar en mis robots</div>
                <div class="searchRow">
                    <input id="mineSearch" placeholder="Ej. MS-014 o KRAKEN" />
                    <button class="btn primary" id="mineSearchBtn">Filtrar</button>
                </div>

                <div class="sectionTitle">Lista</div>
                <div class="list" id="mineList">
                    <div class="row">
                        <div class="left"><b>Cargando…</b><span>—</span></div>
                    </div>
                </div>

                <div class="hint" style="margin-top:12px">
                    “Mis Robots” se arma con los Robot ID que tú registras desde este navegador (localStorage).
                    Si cambias de PC/cel, no se “mueve” (a menos que luego metamos login o un admin-code).
                </div>
            </div>
        </section>

        <div style="height:14px;"></div>

        <!-- =========================
         ✅ TORNEOS
         ========================= -->
        <section id="tournamentsPanel" class="panel hidden">
            <div class="panelHead">
                <div class="title">
                    <h2>Panel organizador</h2>
                    <b>Crear torneo · inscripciones · llaves</b>
                    <span id="tournStatus" style="color:rgba(234,240,255,.65);font-size:12px"></span>
                </div>
                <div class="btnRow">
                    <button class="btn" id="backFromTournaments">Volver</button>
                    <button class="btn" id="btnNew">Nuevo</button>
                    <button class="btn primary" id="btnSaveLocal">Guardar local</button>
                    <button class="btn" id="btnLoadLocal">Abrir local</button>
                    <button class="btn hot" id="btnReset">Reset</button>
                </div>
            </div>

            <div class="content">
                <div class="tGrid">

                    <!-- LEFT -->
                    <div class="panel">
                        <div class="panelHead">
                            <div class="title">
                                <h2>Torneo</h2>
                                <b id="tTitle">Sin nombre</b>
                            </div>
                            <div class="chipRow" id="tChips"></div>
                        </div>

                        <div class="content">
                            <div class="sectionTitle">Datos del torneo</div>
                            <div class="tMiniGrid">
                                <div>
                                    <label>Nombre</label>
                                    <input id="t_name" placeholder="Ej. Copa MiniSumo CDMX 2026" />
                                </div>
                                <div>
                                    <label>Categoría</label>
                                    <select id="t_category">
                                        <option>Mini Sumo Autónomo Profesional</option>
                                        <option>Mini Sumo RC Profesional</option>
                                        <option>Sumo 3kg</option>
                                        <option>Mini Sumo RC Amateur</option>
                                        <option>Mini Sumo Autónomo Amateur</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Sede</label>
                                    <input id="t_venue" placeholder="Ej. ESIME Azcapotzalco" />
                                </div>
                                <div>
                                    <label>Fecha</label>
                                    <input id="t_date" type="date" />
                                </div>

                                <div>
                                    <label>Formato</label>
                                    <select id="t_format">
                                        <option value="single">Eliminación directa (Single)</option>
                                        <option value="groups">Grupos + Eliminación</option>
                                        <option value="double">Doble eliminación (W/L bracket)</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Número de participantes (N)</label>
                                    <input id="t_n" type="number" min="2" value="8" />
                                </div>

                                <div>
                                    <label>Regla (Grupos): # Grupos</label>
                                    <input id="t_groups" type="number" min="2" value="4" />
                                </div>
                                <div>
                                    <label>Regla (Grupos): avanzan por grupo</label>
                                    <input id="t_adv" type="number" min="1" value="2" />
                                </div>
                            </div>

                            <div class="sectionTitle">Búsqueda de robots (robot_cards)</div>
                            <div class="tMiniGrid">
                                <div>
                                    <label>Buscar (Robot ID / Nombre / Equipo)</label>
                                    <input id="r_search" placeholder="Ej. MS-014 o KRAKEN o RoboDragons" />
                                </div>
                                <div>
                                    <label>&nbsp;</label>
                                    <div class="btnRow">
                                        <button class="btn primary" id="btnSearch">Buscar</button>
                                        <button class="btn" id="btnClearSearch">Limpiar</button>
                                    </div>
                                </div>
                            </div>

                            <div class="list" id="searchList" style="margin-top:10px">
                                <div class="row">
                                    <div class="left"><b>Tip</b><span>Busca robots en Supabase y agrégalos como
                                            participantes.</span></div>
                                </div>
                            </div>

                            <div class="sectionTitle">Participantes (seeds)</div>
                            <div class="list" id="playersList">
                                <div class="row">
                                    <div class="left"><b>Vacío</b><span>Agrega robots desde la búsqueda.</span></div>
                                </div>
                            </div>

                            <div class="hint">
                                N puede ser cualquier número. El sistema calcula BYEs automáticamente (nextPow2 - N).
                                BO3: se gana con 2 victorias (2/2).
                                Seeds: se intenta evitar cruzar el mismo equipo en primera ronda.
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT -->
                    <div class="panel">
                        <div class="panelHead">
                            <div class="title">
                                <h2>Vista</h2>
                                <b id="viewTitle">Llaves / grupos</b>
                            </div>

                            <div class="btnRow">
                                <button class="btn primary" id="btnGenerate">Generar</button>
                                <button class="btn" id="btnShuffle">Mezclar seeds</button>
                                <button class="btn" id="btnClearView">Limpiar vista</button>

                                <!-- NUEVO -->
                                <button class="btn" id="btnViewColumns">Vista columnas</button>
                                <button class="btn primary" id="btnViewMap">Vista mapa</button>
                                <button class="btn" id="btnMode">Modo: Organizador</button>
                            </div>
                        </div>

                        <div class="content">
                            <!-- Groups -->
                            <div id="groupsArea" class="groupsWrap hidden">
                                <div class="sectionTitle">Grupos</div>
                                <div class="groupsGrid" id="groupsGrid"></div>
                                <div class="sectionTitle" style="margin-top:14px">Fase final</div>
                                <div class="bracketWrap" id="finalBracketArea">
                                    <div class="bracket" id="finalBracket"></div>
                                </div>

                                <!-- mapa fase final -->
                                <div id="finalMapWrap" class="bracketWrap hidden">
                                    <div class="sectionTitle">Mapa (fase final)</div>
                                    <div id="finalBracketMap"></div>
                                </div>
                            </div>

                            <!-- Single / Double Brackets -->
                            <div id="bracketArea" class="bracketWrap">
                                <div class="bracket" id="bracket"></div>
                            </div>

                            <!-- MAPA principal -->
                            <div id="mapWrap" class="bracketWrap hidden">
                                <div class="sectionTitle">Mapa de bracket (competidores)</div>
                                <div id="bracketMap"></div>
                            </div>

                            <div class="hint" style="margin-top:12px">
                                Nota: Double aún es estructura visual (W/L/GF). Propagación completa la hacemos después.
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <div style="height:14px;"></div>

        <!-- =========================
         ✅ GENERATOR (TU CÓDIGO ORIGINAL)
         ========================= -->
        <div id="generator" class="grid hidden">
            <!-- LEFT -->
            <section class="panel">
                <div class="panelHead">
                    <div class="title">
                        <h2>Datos para el QR</h2>
                        <b>Robot</b>
                    </div>
                    <div class="btnRow">
                        <button class="btn" id="btnBackToDash">Volver</button>
                        <button class="btn primary" id="btnGenOffline">Generar QR</button>
                        <button class="btn" id="btnGenLink">Generar QR (link)</button>
                    </div>
                </div>

                <div class="content">
                    <div class="sectionTitle">Básico</div>
                    <div class="formGrid">
                        <div>
                            <label>Robot ID (único)</label>
                            <input id="robot_id" placeholder="Ej. MS-014" />
                        </div>
                        <div>
                            <label>Nombre del robot</label>
                            <input id="robot_nombre" placeholder="Ej. KRAKEN" />
                        </div>

                        <div>
                            <label>Categoría</label>
                            <select id="categoria">
                                <option value="">(selecciona)</option>
                                <option>Mini Sumo</option>
                                <option>Mini Sumo 500g</option>
                                <option>Sumo 3kg</option>
                                <option>Combate</option>
                                <option>Seguidor de línea</option>
                                <option>Otro</option>
                            </select>
                        </div>
                        <div>
                            <label>Equipo</label>
                            <input id="equipo" placeholder="Ej. RoboDragons" />
                        </div>

                        <div>
                            <label>Controlador / Piloto</label>
                            <input id="controlador" placeholder="Nombre del piloto" />
                        </div>
                        <div>
                            <label>Escuela</label>
                            <input id="escuela" placeholder="Ej. ESIME Azcapotzalco" />
                        </div>
                    </div>

                    <div class="sectionTitle">Opcional</div>
                    <div class="formGrid">
                        <div>
                            <label>Peso (g)</label>
                            <input id="peso_g" type="number" min="0" placeholder="Ej. 498" />
                        </div>
                        <div>
                            <label>Dimensiones (mm)</label>
                            <input id="dimensiones_mm" placeholder='Ej. 100×100×55' />
                        </div>

                        <div>
                            <label>Tipo de control</label>
                            <select id="tipo_control">
                                <option value="">(opcional)</option>
                                <option>Autónomo</option>
                                <option>RC</option>
                                <option>Híbrido</option>
                            </select>
                        </div>
                        <div>
                            <label>Frecuencia / Protocolo (si aplica)</label>
                            <input id="frecuencia_protocolo" placeholder="Ej. 2.4GHz / ELRS / SBUS" />
                        </div>

                        <div>
                            <label>Contacto</label>
                            <input id="contacto" placeholder="IG / WhatsApp / Email" />
                        </div>
                        <div>
                            <label>Estado de inspección</label>
                            <select id="inspeccion_estado">
                                <option value="pendiente">pendiente</option>
                                <option value="aprobado">aprobado</option>
                                <option value="rechazado">rechazado</option>
                            </select>
                        </div>

                        <div style="grid-column:1/-1">
                            <label>Checklist de inspección (1 por línea)</label>
                            <textarea id="inspeccion_checklist" placeholder="Ej.
Peso ok
Kill-switch ok
Batería segura"></textarea>
                        </div>

                        <div>
                            <label>Foto del robot (URL)</label>
                            <input id="foto_url" placeholder="https://..." />
                        </div>
                        <div>
                            <label>Logo del equipo (URL)</label>
                            <input id="logo_url" placeholder="https://..." />
                        </div>
                    </div>

                    <div class="btnRow" style="margin-top:12px">
                        <button class="btn" id="btnSave">Guardar en este navegador</button>
                        <button class="btn" id="btnLoad">Cargar guardado</button>
                        <button class="btn hot" id="btnClear">Limpiar</button>
                    </div>

                    <div class="hint">
                        Nota: <b>offline</b> mete los datos dentro del QR como JSON compacto. El modo <b>link</b> genera
                        un QR que abre una credencial visual.
                        <br><br>
                        ✅ Con Supabase: al generar/guardar, también se sube a la base de datos.
                    </div>
                </div>
            </section>

            <!-- RIGHT -->
            <section class="panel">
                <div class="panelHead">
                    <div class="title">
                        <h2>Escanéalo con cámara</h2>
                        <b>Robot QR</b>
                    </div>
                    <div class="btnRow">
                        <button class="btn" id="btnDownload">Descargar QR (PNG)</button>
                        <button class="btn" id="btnOpen">Abrir link</button>
                        <button class="btn" id="btnCopy">Copiar payload</button>
                    </div>
                </div>

                <div class="rightBox">
                    <div class="qrBox">
                        <canvas id="qrCanvas" width="320" height="320" style="width:320px;height:320px"></canvas>
                    </div>

                    <div class="qrCard">
                        <div class="chipRow" id="chipRow"></div>
                        <div class="kv" id="previewKV" style="margin-top:10px"></div>
                        <div class="mono" id="payloadPreview">Payload (preview): —</div>
                    </div>

                    <div class="hint" style="margin-top:10px">
                        Tip: imprime QR negro/blanco ≥ 3 cm, y evita pegarlos en superficies muy curvas.
                    </div>
                </div>
            </section>
        </div>

        <div style="height:14px;"></div>

        <!-- VIEWER -->
        <section id="viewer" class="panel viewer">
            <div class="panelHead">
                <div class="title">
                    <h2>Credencial del robot</h2>
                    <b id="v_name">—</b>
                </div>
                <div class="btnRow">
                    <button class="btn" id="btnBack">Volver</button>
                </div>
            </div>

            <div class="viewer" style="display:block">
                <div class="viewerGrid">
                    <div class="panel" style="border-radius:18px">
                        <div class="content">
                            <h1 class="bigTitle" id="v_title">—</h1>
                            <div class="sub" id="v_sub">—</div>
                            <div class="chipRow" id="v_chips"></div>
                            <div class="kv" id="v_kv" style="margin-top:12px"></div>

                            <div class="sectionTitle" style="margin-top:14px">Checklist</div>
                            <div class="mono" id="v_check">—</div>
                        </div>
                    </div>

                    <div class="panel" style="border-radius:18px">
                        <div class="content">
                            <div class="sectionTitle">Foto</div>
                            <div class="mediaBox">
                                <img id="v_photo" alt="Foto robot" />
                                <div class="fallback" id="v_photo_f">NO PHOTO</div>
                            </div>

                            <div class="sectionTitle" style="margin-top:14px">Logo</div>
                            <div class="mediaBox" style="min-height:160px">
                                <img id="v_logo" alt="Logo equipo" />
                                <div class="fallback" id="v_logo_f">LOGO</div>
                            </div>

                            <div class="hint" style="margin-top:12px">
                                Este QR es solo identificación. No valida torneo ni registros.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script>
        /* =========================================================
           ✅ SUPABASE CONFIG (TUS DATOS)
           ========================================================= */
        const SUPABASE_URL = "https://pddjulxliqlqoopveugh.supabase.co";
        const SUPABASE_ANON_KEY = "sb_publishable_BgfIRiHsUgqPhCqZ4L8yEA_wjarKci0";
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const TABLE = "robot_cards";

        /* =========================================================
           ✅ LOCAL "MIS ROBOTS" (SIN LOGIN)
           ========================================================= */
        const MY_LIST_KEY = "apex_my_robot_ids_v1";
        function getMyList() {
            try { return JSON.parse(localStorage.getItem(MY_LIST_KEY) || "[]"); }
            catch (_) { return []; }
        }
        function addToMyList(robotId) {
            const rid = (robotId || "").trim();
            if (!rid) return;
            const list = getMyList();
            if (!list.includes(rid)) {
                list.unshift(rid);
                localStorage.setItem(MY_LIST_KEY, JSON.stringify(list.slice(0, 200)));
            }
        }
        function clearMyList() {
            localStorage.removeItem(MY_LIST_KEY);
        }

        /* --------------------------
           Compact payload + Base64URL (legacy soporte #view=)
        --------------------------- */
        function cleanStr(s) { return (s || "").toString().trim(); }
        function base64UrlEncode(str) {
            const b64 = btoa(unescape(encodeURIComponent(str)));
            return b64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }
        function base64UrlDecode(b64u) {
            let b64 = b64u.replace(/-/g, '+').replace(/_/g, '/');
            while (b64.length % 4) b64 += '=';
            return decodeURIComponent(escape(atob(b64)));
        }

        function buildRobotObj() {
            const checklist = cleanStr(document.getElementById("inspeccion_checklist").value)
                .split("\n").map(s => s.trim()).filter(Boolean);

            const obj = {
                v: 1,
                i: cleanStr(robot_id.value),
                n: cleanStr(robot_nombre.value),
                c: cleanStr(categoria.value),
                t: cleanStr(equipo.value),
                p: cleanStr(controlador.value),
                s: cleanStr(escuela.value),
            };

            const peso = cleanStr(peso_g.value);
            const dim = cleanStr(dimensiones_mm.value);
            const type = cleanStr(tipo_control.value);
            const freq = cleanStr(frecuencia_protocolo.value);
            const cont = cleanStr(contacto.value);
            const ist = cleanStr(inspeccion_estado.value);
            const foto = cleanStr(foto_url.value);
            const logo = cleanStr(logo_url.value);

            if (peso) obj.w = Number(peso);
            if (dim) obj.d = dim;
            if (type) obj.y = type;
            if (freq) obj.f = freq;
            if (cont) obj.k = cont;
            if (ist) obj.a = ist;
            if (checklist.length) obj.l = checklist;
            if (foto) obj.u = foto;
            if (logo) obj.g = logo;

            return obj;
        }

        function prettyFromCompact(o) {
            return {
                robot_id: o.i || "",
                robot_nombre: o.n || "",
                categoria: o.c || "",
                equipo: o.t || "",
                controlador: o.p || "",
                escuela: o.s || "",
                peso_g: o.w ?? "",
                dimensiones_mm: o.d || "",
                tipo_control: o.y || "",
                frecuencia_protocolo: o.f || "",
                contacto: o.k || "",
                inspeccion_estado: o.a || "pendiente",
                inspeccion_checklist: Array.isArray(o.l) ? o.l : [],
                foto_url: o.u || "",
                logo_url: o.g || "",
            };
        }

        /* --------------------------
           UI Helpers
        --------------------------- */
        function setKV(container, rows) {
            container.innerHTML = "";
            for (const [k, v] of rows) {
                if (v === undefined || v === null || v === "") continue;
                const kEl = document.createElement("div"); kEl.className = "k"; kEl.textContent = k;
                const vEl = document.createElement("div"); vEl.className = "v"; vEl.textContent = v;
                container.appendChild(kEl); container.appendChild(vEl);
            }
        }

        function setChips(container, chips) {
            container.innerHTML = "";
            chips.forEach(ch => {
                const el = document.createElement("div");
                el.className = "chip " + (ch.cls || "");
                el.textContent = ch.text;
                container.appendChild(el);
            });
        }

        function statusCls(state) {
            if (state === "aprobado") return "good";
            if (state === "rechazado") return "bad";
            return "warn";
        }

        /* =========================================================
           ✅ PAYLOADS
        ========================================================= */
        function payloadOffline(robotObj) { return JSON.stringify(robotObj); }
        function payloadLink(robotObj) {
            const base = "https://areivan.github.io/Minisumo_QR/";
            const rid = encodeURIComponent(robotObj.i || "");
            return base + "#id=" + rid;
        }

        /* =========================================================
           ✅ SUPABASE CRUD (tu tabla robot_cards)
           ========================================================= */
        async function saveToSupabase(compact) {
            const robot_id = (compact.i || "").trim();
            if (!robot_id) throw new Error("robot_id vacío");

            const row = {
                robot_id,
                data: compact,
                qr_link: payloadLink(compact),
                qr_offline: payloadOffline(compact),
            };

            const { data, error } = await sb
                .from(TABLE)
                .upsert(row, { onConflict: "robot_id" })
                .select("robot_id, qr_link, updated_at, created_at")
                .single();

            if (error) throw error;
            return data;
        }

        async function loadFromSupabaseByRobotId(robot_id) {
            const { data, error } = await sb
                .from(TABLE)
                .select("robot_id, data, qr_link, qr_offline, updated_at, created_at")
                .eq("robot_id", robot_id)
                .single();

            if (error) throw error;
            return data;
        }

        /* =========================================================
           ✅ QR render estable
           ========================================================= */
        const STORAGE_KEY = "apex_robot_qr_saved_v1";
        let lastPayload = "";
        let lastPayloadType = ""; // "offline" | "link"

        function drawQR(text) {
            try {
                lastPayload = text;

                const qr = qrcode(0, "Q");
                qr.addData(text);
                qr.make();

                const canvas = document.getElementById("qrCanvas");
                const ctx = canvas.getContext("2d");

                const count = qr.getModuleCount();
                const scale = 8;
                const margin = 16;

                canvas.width = canvas.height = count * scale + margin * 2;

                ctx.fillStyle = "#fff";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = "#000";
                for (let r = 0; r < count; r++) {
                    for (let c = 0; c < count; c++) {
                        if (qr.isDark(r, c)) {
                            ctx.fillRect(margin + c * scale, margin + r * scale, scale, scale);
                        }
                    }
                }

                payloadPreview.textContent = "Payload (preview):\n" + text;
            } catch (err) {
                payloadPreview.textContent = "ERROR QR: " + (err?.message || err);
                console.error(err);
            }
        }

        /* --------------------------
           Preview Card (generator)
        --------------------------- */
        function renderPreviewFromCompact(compact) {
            const o = prettyFromCompact(compact);
            setChips(chipRow, [
                { text: o.categoria || "Categoría —" },
                { text: "Control: " + (o.tipo_control || "—") },
                { text: "Inspección: " + (o.inspeccion_estado || "—"), cls: statusCls(o.inspeccion_estado) }
            ]);

            setKV(previewKV, [
                ["Robot ID", o.robot_id],
                ["Nombre", o.robot_nombre],
                ["Equipo", o.equipo],
                ["Piloto", o.controlador],
                ["Escuela", o.escuela],
                ["Peso", o.peso_g ? `${o.peso_g} g` : ""],
                ["Dimensiones", o.dimensiones_mm],
                ["Freq/Proto", o.frecuencia_protocolo],
                ["Contacto", o.contacto],
            ]);
        }

        /* --------------------------
           Viewer mode (#id=... o legacy #view=...)
        --------------------------- */
        function showViewer(compact) {
            const o = prettyFromCompact(compact);

            dashboard.classList.add("hidden");
            minePanel.classList.add("hidden");
            generator.classList.add("hidden");
            viewer.style.display = "block";

            modeBadge.textContent = "viewer";

            v_name.textContent = o.robot_nombre || "Robot";
            v_title.textContent = (o.robot_nombre || "—") + (o.robot_id ? ` · ${o.robot_id}` : "");
            v_sub.textContent = `${o.categoria || "—"} · ${o.equipo || "—"} · ${o.escuela || "—"}`;

            const chips = [
                { text: o.categoria || "Categoría —" },
                { text: "Equipo: " + (o.equipo || "—") },
                { text: "Control: " + (o.tipo_control || "—") },
                { text: "Inspección: " + (o.inspeccion_estado || "—"), cls: statusCls(o.inspeccion_estado) }
            ];
            setChips(v_chips, chips);

            setKV(v_kv, [
                ["Robot ID", o.robot_id],
                ["Nombre", o.robot_nombre],
                ["Equipo", o.equipo],
                ["Piloto", o.controlador],
                ["Escuela", o.escuela],
                ["Peso", o.peso_g ? `${o.peso_g} g` : ""],
                ["Dimensiones", o.dimensiones_mm],
                ["Frecuencia/Protocolo", o.frecuencia_protocolo],
                ["Contacto", o.contacto],
            ]);

            const lines = (o.inspeccion_checklist && o.inspeccion_checklist.length)
                ? o.inspeccion_checklist.map(x => "• " + x).join("\n")
                : "—";
            v_check.textContent = lines;

            if (o.foto_url) {
                v_photo.src = o.foto_url;
                v_photo.style.display = "block";
                v_photo_f.style.display = "none";
            } else {
                v_photo.style.display = "none";
                v_photo_f.style.display = "block";
            }
            if (o.logo_url) {
                v_logo.src = o.logo_url;
                v_logo.style.display = "block";
                v_logo_f.style.display = "none";
            } else {
                v_logo.style.display = "none";
                v_logo_f.style.display = "block";
            }
        }

        /* =========================
           ✅ ROUTER
           - #/         dashboard
           - #/new      generator
           - #/mine     mine list
           - #id=RID    viewer (compat con tus QRs)
           ========================= */
        function showDashboard() {
            viewer.style.display = "none";
            tournamentsPanel.classList.add("hidden");
            generator.classList.add("hidden");
            minePanel.classList.add("hidden");
            dashboard.classList.remove("hidden");
            modeBadge.textContent = "dashboard";
            refreshDashboard().catch(console.error);
        }

        function showGenerator() {
            viewer.style.display = "none";
            dashboard.classList.add("hidden");
            minePanel.classList.add("hidden");
            tournamentsPanel.classList.add("hidden");
            generator.classList.remove("hidden");
            modeBadge.textContent = "generator";
            // pinta canvas blanco si está vacío
            const ctx = qrCanvas.getContext("2d");
            ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, qrCanvas.width, qrCanvas.height);
        }

        function showMine() {
            viewer.style.display = "none";
            dashboard.classList.add("hidden");
            generator.classList.add("hidden");
            tournamentsPanel.classList.add("hidden");
            minePanel.classList.remove("hidden");
            modeBadge.textContent = "mine";
            loadMineList().catch(console.error);
        }
        function showTournaments() {
            viewer.style.display = "none";
            dashboard.classList.add("hidden");
            minePanel.classList.add("hidden");
            generator.classList.add("hidden");
            tournamentsPanel.classList.remove("hidden");
            modeBadge.textContent = "tournaments";
            // status limpio
            try { tournStatus.textContent = ""; } catch (_) { }
        }


        async function route() {
            const hash = location.hash || "";

            // ✅ Viewer por #id=
            if (hash.startsWith("#id=")) {
                const rid = decodeURIComponent(hash.slice(4));
                try {
                    const rec = await loadFromSupabaseByRobotId(rid);
                    showViewer(rec.data);
                    return;
                } catch (e) {
                    console.error(e);
                    alert("No se encontró este Robot ID en Supabase: " + rid);
                    location.hash = "#/";
                    return;
                }
            }

            // ✅ Legacy viewer por #view=
            if (hash.startsWith("#view=")) {
                const b64u = hash.slice(6);
                try {
                    const json = base64UrlDecode(b64u);
                    const compact = JSON.parse(json);
                    showViewer(compact);
                    return;
                } catch (err) {
                    console.warn(err);
                    location.hash = "#/";
                    return;
                }
            }

            // ✅ App routes
            if (hash === "#/new") return showGenerator();
            if (hash === "#/mine") return showMine();
            if (hash === "#/tournaments") return showTournaments();
            return showDashboard();
        }

        /* =========================
           ✅ DASHBOARD DATA
           ========================= */
        function esc(s) { return (s || "").toString().replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[m])); }

        async function refreshDashboard() {
            miniStatus.textContent = "· cargando…";

            // Total count
            const totalRes = await sb.from(TABLE).select("*", { count: "exact", head: true });
            const total = totalRes.count ?? 0;
            statTotal.textContent = total.toLocaleString("es-MX");

            // Today count (si created_at existe)
            let todayCount = "—";
            try {
                const start = new Date();
                start.setHours(0, 0, 0, 0);
                const iso = start.toISOString();
                const r = await sb.from(TABLE).select("*", { count: "exact", head: true }).gte("created_at", iso);
                if (!r.error) todayCount = (r.count ?? 0).toLocaleString("es-MX");
            } catch (_) { }
            statToday.textContent = todayCount;

            // Mine count
            const mineIds = getMyList();
            statMine.textContent = mineIds.length.toLocaleString("es-MX");

            // Latest list
            const { data, error } = await sb
                .from(TABLE)
                .select("robot_id, data, created_at, updated_at")
                .order("updated_at", { ascending: false })
                .limit(8);

            if (error) {
                latestList.innerHTML = `<div class="row"><div class="left"><b>Error</b><span>${esc(error.message)}</span></div></div>`;
            } else if (!data || data.length === 0) {
                latestList.innerHTML = `<div class="row"><div class="left"><b>Sin registros</b><span>Aún no hay robots.</span></div></div>`;
            } else {
                latestList.innerHTML = data.map(r => {
                    const name = r?.data?.n || "Robot";
                    const team = r?.data?.t || "";
                    const cat = r?.data?.c || "";
                    const sub = [r.robot_id, cat, team].filter(Boolean).join(" · ");
                    return `
            <div class="row">
              <div class="left">
                <b title="${esc(name)}">${esc(name)}</b>
                <span title="${esc(sub)}">${esc(sub)}</span>
              </div>
              <div class="right">
                <button class="btn" data-open="${esc(r.robot_id)}">Ver</button>
              </div>
            </div>
          `;
                }).join("");

                latestList.querySelectorAll("[data-open]").forEach(btn => {
                    btn.addEventListener("click", () => {
                        const rid = btn.getAttribute("data-open");
                        location.hash = "#id=" + encodeURIComponent(rid);
                    });
                });
            }

            miniStatus.textContent = "· listo ✅";
        }

        /* =========================
           ✅ MINE LIST
           ========================= */
        let mineCache = []; // array de registros supabase
        async function loadMineList() {
            const ids = getMyList();

            if (!ids.length) {
                mineList.innerHTML = `<div class="row"><div class="left"><b>Vacío</b><span>Aún no registras robots desde este navegador.</span></div></div>`;
                mineCache = [];
                return;
            }

            // Traer en batch
            const { data, error } = await sb
                .from(TABLE)
                .select("robot_id, data, updated_at, created_at")
                .in("robot_id", ids);

            if (error) {
                mineList.innerHTML = `<div class="row"><div class="left"><b>Error</b><span>${esc(error.message)}</span></div></div>`;
                mineCache = [];
                return;
            }

            // Ordenar según el orden local (más reciente primero)
            const map = new Map((data || []).map(r => [r.robot_id, r]));
            mineCache = ids.map(id => map.get(id)).filter(Boolean);

            renderMine(mineCache);
        }

        function renderMine(rows) {
            if (!rows.length) {
                mineList.innerHTML = `<div class="row"><div class="left"><b>Sin datos</b><span>No pude cargar tus robots (quizá los borraste en DB).</span></div></div>`;
                return;
            }

            mineList.innerHTML = rows.map(r => {
                const name = r?.data?.n || "Robot";
                const team = r?.data?.t || "";
                const cat = r?.data?.c || "";
                const sub = [r.robot_id, cat, team].filter(Boolean).join(" · ");
                return `
          <div class="row">
            <div class="left">
              <b title="${esc(name)}">${esc(name)}</b>
              <span title="${esc(sub)}">${esc(sub)}</span>
            </div>
            <div class="right">
              <button class="btn" data-open="${esc(r.robot_id)}">Ver</button>
            </div>
          </div>
        `;
            }).join("");

            mineList.querySelectorAll("[data-open]").forEach(btn => {
                btn.addEventListener("click", () => {
                    const rid = btn.getAttribute("data-open");
                    location.hash = "#id=" + encodeURIComponent(rid);
                });
            });
        }

        function filterMine() {
            const q = (mineSearch.value || "").trim().toLowerCase();
            if (!q) return renderMine(mineCache);
            const filtered = mineCache.filter(r => {
                const rid = (r.robot_id || "").toLowerCase();
                const name = (r?.data?.n || "").toLowerCase();
                const team = (r?.data?.t || "").toLowerCase();
                return rid.includes(q) || name.includes(q) || team.includes(q);
            });
            renderMine(filtered);
        }

        /* --------------------------
           Buttons (GENERATOR)
        --------------------------- */
        function validateBasic() {
            const id = cleanStr(robot_id.value);
            const name = cleanStr(robot_nombre.value);
            if (!id || !name) {
                alert("Pon al menos Robot ID y Nombre del robot.");
                return false;
            }
            return true;
        }

        // ✅ Generar OFFLINE + guardar en Supabase
        btnGenOffline.onclick = async () => {
            if (!validateBasic()) return;
            const compact = buildRobotObj();
            renderPreviewFromCompact(compact);

            lastPayloadType = "offline";
            drawQR(payloadOffline(compact));

            localStorage.setItem(STORAGE_KEY, JSON.stringify(compact));

            try {
                const saved = await saveToSupabase(compact);
                addToMyList(saved.robot_id); // ✅ agrega a "Mis Robots"
            } catch (e) {
                console.error(e);
                alert("No se pudo guardar en Supabase: " + (e.message || e));
            }
        };

        // ✅ Generar LINK + guardar en Supabase
        btnGenLink.onclick = async () => {
            if (!validateBasic()) return;
            const compact = buildRobotObj();
            renderPreviewFromCompact(compact);

            lastPayloadType = "link";
            const link = payloadLink(compact);
            drawQR(link);

            localStorage.setItem(STORAGE_KEY, JSON.stringify(compact));

            try {
                const saved = await saveToSupabase(compact);
                addToMyList(saved.robot_id); // ✅ agrega a "Mis Robots"
            } catch (e) {
                console.error(e);
                alert("No se pudo guardar en Supabase: " + (e.message || e));
            }
        };

        btnCopy.onclick = async () => {
            if (!lastPayload) { alert("Primero genera un QR."); return; }
            try {
                await navigator.clipboard.writeText(lastPayload);
            } catch (e) {
                const ta = document.createElement("textarea");
                ta.value = lastPayload; document.body.appendChild(ta);
                ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
            }
        };

        btnOpen.onclick = () => {
            if (!lastPayload) { alert("Primero genera un QR."); return; }
            if (!/^https?:\/\//i.test(lastPayload)) {
                alert("Este QR es OFFLINE (JSON). Genera el QR (link) para abrir en navegador.");
                return;
            }
            window.open(lastPayload, "_blank");
        };

        btnDownload.onclick = () => {
            const a = document.createElement("a");
            a.download = "apex_robot_qr.png";
            a.href = qrCanvas.toDataURL("image/png");
            a.click();
        };

        // Guardar en navegador + también subir a Supabase
        btnSave.onclick = async () => {
            const compact = buildRobotObj();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(compact));

            try {
                if (!compact.i || !compact.n) {
                    alert("Guardado local. Para Supabase, pon al menos Robot ID y Nombre.");
                    return;
                }
                const saved = await saveToSupabase(compact);
                addToMyList(saved.robot_id);
                alert("Guardado (local + Supabase).");
            } catch (e) {
                console.error(e);
                alert("Guardado local. Supabase falló: " + (e.message || e));
            }
        };

        // Cargar guardado:
        btnLoad.onclick = async () => {
            const rid = cleanStr(robot_id.value);

            if (rid) {
                try {
                    const rec = await loadFromSupabaseByRobotId(rid);
                    const o = rec.data;

                    robot_id.value = o.i || "";
                    robot_nombre.value = o.n || "";
                    categoria.value = o.c || "";
                    equipo.value = o.t || "";
                    controlador.value = o.p || "";
                    escuela.value = o.s || "";

                    peso_g.value = (o.w ?? "");
                    dimensiones_mm.value = o.d || "";
                    tipo_control.value = o.y || "";
                    frecuencia_protocolo.value = o.f || "";
                    contacto.value = o.k || "";
                    inspeccion_estado.value = o.a || "pendiente";
                    inspeccion_checklist.value = (o.l || []).join("\n");
                    foto_url.value = o.u || "";
                    logo_url.value = o.g || "";

                    renderPreviewFromCompact(o);

                    lastPayloadType = "link";
                    drawQR(rec.qr_link);

                    localStorage.setItem(STORAGE_KEY, JSON.stringify(o));
                    return;
                } catch (e) {
                    console.error(e);
                    alert("No se pudo cargar desde Supabase: " + (e.message || e));
                }
            }

            // fallback local
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) { alert("No hay guardado local. Escribe Robot ID y dale Cargar para Supabase."); return; }
            const o = JSON.parse(raw);

            robot_id.value = o.i || "";
            robot_nombre.value = o.n || "";
            categoria.value = o.c || "";
            equipo.value = o.t || "";
            controlador.value = o.p || "";
            escuela.value = o.s || "";

            peso_g.value = (o.w ?? "");
            dimensiones_mm.value = o.d || "";
            tipo_control.value = o.y || "";
            frecuencia_protocolo.value = o.f || "";
            contacto.value = o.k || "";
            inspeccion_estado.value = o.a || "pendiente";
            inspeccion_checklist.value = (o.l || []).join("\n");
            foto_url.value = o.u || "";
            logo_url.value = o.g || "";

            renderPreviewFromCompact(o);
            lastPayloadType = "link";
            drawQR(payloadLink(o));
        };

        btnClear.onclick = () => {
            ["robot_id", "robot_nombre", "equipo", "controlador", "escuela",
                "peso_g", "dimensiones_mm", "frecuencia_protocolo", "contacto",
                "inspeccion_checklist", "foto_url", "logo_url"
            ].forEach(id => document.getElementById(id).value = "");

            categoria.value = "";
            tipo_control.value = "";
            inspeccion_estado.value = "pendiente";

            chipRow.innerHTML = "";
            previewKV.innerHTML = "";
            payloadPreview.textContent = "Payload (preview): —";

            const ctx = qrCanvas.getContext("2d");
            ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, qrCanvas.width, qrCanvas.height);

            lastPayload = "";
            lastPayloadType = "";
        };

        /* =========================
           ✅ DASHBOARD / MINE UI EVENTS
           ========================= */
        goRegister.onclick = () => location.hash = "#/new";
        goMine.onclick = () => location.hash = "#/mine";
        goTournaments.onclick = () => location.hash = "#/tournaments";
        refreshDash.onclick = () => refreshDashboard().catch(console.error);

        cardHome.onclick = () => location.hash = "#/";
        cardNew.onclick = () => location.hash = "#/new";
        cardMine.onclick = () => location.hash = "#/mine";
        cardTournaments.onclick = () => location.hash = "#/tournaments";

        btnBackToDash.onclick = () => location.hash = "#/";

        btnSearchRid.onclick = () => {
            const rid = (searchRid.value || "").trim();
            if (!rid) return alert("Escribe un Robot ID.");
            location.hash = "#id=" + encodeURIComponent(rid);
        };
        searchRid.addEventListener("keydown", (e) => { if (e.key === "Enter") btnSearchRid.click(); });

        backFromMine.onclick = () => location.hash = "#/";
        backFromTournaments.onclick = () => location.hash = "#/";
        reloadMine.onclick = () => loadMineList().catch(console.error);
        clearMine.onclick = () => {
            if (!confirm("¿Borrar tu lista local de Mis Robots? (No borra la base de datos)")) return;
            clearMyList();
            loadMineList().catch(console.error);
            refreshDashboard().catch(console.error);
        };

        mineSearchBtn.onclick = filterMine;
        mineSearch.addEventListener("input", filterMine);
        mineSearch.addEventListener("keydown", (e) => { if (e.key === "Enter") mineSearchBtn.click(); });

        btnBack.onclick = () => {
            // volver a dashboard (más consistente)
            location.hash = "#/";
        };

        /* --------------------------
           Boot
        --------------------------- */
        (async function boot() {
            // canvas blanco inicial
            try {
                const ctx = qrCanvas.getContext("2d");
                ctx.fillStyle = "#fff"; ctx.fillRect(0, 0, qrCanvas.width, qrCanvas.height);
            } catch (_) { }

            // carga el cache local si existe (para que el generator tenga algo al abrir)
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const o = JSON.parse(saved);
                    renderPreviewFromCompact(o);
                    lastPayloadType = "link";
                    drawQR(payloadLink(o));
                } catch (_) { }
            }

            // router
            window.addEventListener("hashchange", route);
            await route();
        })();
    </script>

    <script>
        // =========================
        // TOURNAMENT MODULE (merged)
        // =========================
        (function () {
            const ROBOT_TABLE = "robot_cards";
            /* =========================
                       Helpers / State
                       ========================= */
            const $ = (id) => document.getElementById(id);

            const state = {
                tournament: {
                    name: "",
                    category: "Mini Sumo Autónomo Profesional",
                    venue: "",
                    date: "",
                    format: "single",
                    n: 8,
                    groups: 4,
                    adv: 2
                },
                players: [],
                view: null, // { type, bracket / groups / finalBracket / dbl }
            };

            function esc(s) {
                return String(s ?? "").replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;" }[m]));
            }

            function nextPow2(n) { let p = 1; while (p < n) p <<= 1; return p; }
            function clamp(n, a, b) { return Math.max(a, Math.min(b, n)); }

            /* =========================
               BO3 Categories
               ========================= */
            const BO3_CATEGORIES = new Set([
                "Mini Sumo Autónomo Profesional",
                "Mini Sumo RC Profesional",
                "Sumo 3kg",
                "Mini Sumo RC Amateur",
                "Mini Sumo Autónomo Amateur",
            ]);

            function isBO3() {
                return BO3_CATEGORIES.has(state.tournament.category);
            }

            function getTeam(compact) {
                return (compact?.t || "").trim() || "SIN_EQUIPO";
            }

            function robotLabel(compact) {
                const rid = compact?.i || "";
                const name = compact?.n || "Robot";
                const team = compact?.t || "";
                const cat = compact?.c || "";
                return { rid, name, sub: [rid, cat, team].filter(Boolean).join(" · ") };
            }

            function shuffleArray(arr) {
                const a = arr.slice();
                for (let i = a.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [a[i], a[j]] = [a[j], a[i]];
                }
                return a;
            }

            /* =========================
               Chips / UI sync
               ========================= */
            function setChips() {
                const t = state.tournament;
                const np2 = nextPow2(Math.max(2, t.n));
                const byes = np2 - t.n;
                const wrap = $("tChips");
                wrap.innerHTML = "";

                const chips = [
                    { text: `Cat: ${t.category}`, cls: "good" },
                    { text: `Formato: ${t.format}`, cls: "" },
                    { text: `Regla: ${isBO3() ? "BO3 (2 wins)" : "Simple"}`, cls: isBO3() ? "good" : "" },
                    { text: `N: ${t.n}`, cls: "warn" },
                    { text: `Bracket: ${np2}`, cls: "" },
                    { text: `BYEs: ${byes}`, cls: byes ? "warn" : "good" },
                    { text: t.date ? `Fecha: ${t.date}` : "Fecha: —", cls: "" }
                ];

                chips.forEach(c => {
                    const d = document.createElement("div");
                    d.className = "chip " + (c.cls || "");
                    d.textContent = c.text;
                    wrap.appendChild(d);
                });

                $("tTitle").textContent = t.name || "Sin nombre";
                // mode badge removed in merged UI
            }

            function syncTournamentFromForm() {
                state.tournament.name = $("t_name").value.trim();
                state.tournament.category = $("t_category").value;
                state.tournament.venue = $("t_venue").value.trim();
                state.tournament.date = $("t_date").value;
                state.tournament.format = $("t_format").value;

                state.tournament.n = Math.max(2, parseInt($("t_n").value || "2", 10));
                state.tournament.groups = Math.max(2, parseInt($("t_groups").value || "2", 10));
                state.tournament.adv = Math.max(1, parseInt($("t_adv").value || "1", 10));

                setChips();
                updateViewMode();
            }

            ["t_name", "t_category", "t_venue", "t_date", "t_format", "t_n", "t_groups", "t_adv"].forEach(id => {
                $(id).addEventListener("input", syncTournamentFromForm);
                $(id).addEventListener("change", syncTournamentFromForm);
            });

            /* =========================
               Search robots (mismo flujo)
               ========================= */
            async function searchRobots() {
                const q = $("r_search").value.trim();
                if (!q) {
                    $("searchList").innerHTML = `<div class="row"><div class="left"><b>Tip</b><span>Escribe algo para buscar.</span></div></div>`;
                    return;
                }

                $("tournStatus").textContent = "· buscando…";
                $("searchList").innerHTML = `<div class="row"><div class="left"><b>Buscando…</b><span>Supabase</span></div></div>`;

                const { data, error } = await sb
                    .from(ROBOT_TABLE)
                    .select("robot_id, data, updated_at, created_at")
                    .order("updated_at", { ascending: false })
                    .limit(250);

                if (error) {
                    $("searchList").innerHTML = `<div class="row"><div class="left"><b>Error</b><span>${esc(error.message)}</span></div></div>`;
                    $("tournStatus").textContent = "";
                    return;
                }

                const qq = q.toLowerCase();
                const res = (data || []).filter(r => {
                    const rid = (r.robot_id || "").toLowerCase();
                    const n = (r?.data?.n || "").toLowerCase();
                    const t = (r?.data?.t || "").toLowerCase();
                    return rid.includes(qq) || n.includes(qq) || t.includes(qq);
                }).slice(0, 30);

                if (!res.length) {
                    $("searchList").innerHTML = `<div class="row"><div class="left"><b>Sin resultados</b><span>Prueba otro texto.</span></div></div>`;
                    $("tournStatus").textContent = "";
                    return;
                }

                $("searchList").innerHTML = res.map(r => {
                    const info = robotLabel(r.data);
                    const already = state.players.some(p => p.i === r.data.i);
                    return `
              <div class="row">
                <div class="left">
                  <b title="${esc(info.name)}">${esc(info.name)}</b>
                  <span title="${esc(info.sub)}">${esc(info.sub)}</span>
                </div>
                <div class="right">
                  <button class="btn ${already ? "ghost" : "primary"}" data-add="${esc(r.robot_id)}">${already ? "Agregado" : "Agregar"}</button>
                  <button class="btn" data-open="${esc(r.robot_id)}">Ver</button>
                </div>
              </div>
            `;
                }).join("");

                $("searchList").querySelectorAll("[data-add]").forEach(b => {
                    b.addEventListener("click", () => {
                        const rid = b.getAttribute("data-add");
                        const row = res.find(x => x.robot_id === rid);
                        if (!row) return;
                        addPlayer(row.data);
                        renderPlayers();
                        syncParticipantsToN();
                        b.textContent = "Agregado";
                        b.classList.remove("primary");
                        b.classList.add("ghost");
                    });
                });

                $("searchList").querySelectorAll("[data-open]").forEach(b => {
                    b.addEventListener("click", () => {
                        const rid = b.getAttribute("data-open");
                        window.open(`https://areivan.github.io/Minisumo_QR/#id=${encodeURIComponent(rid)}`, "_blank");
                    });
                });

                $("tournStatus").textContent = "· listo ✅";
            }

            $("btnSearch").onclick = searchRobots;
            $("r_search").addEventListener("keydown", (e) => { if (e.key === "Enter") searchRobots(); });
            $("btnClearSearch").onclick = () => {
                $("r_search").value = "";
                $("searchList").innerHTML = `<div class="row"><div class="left"><b>Tip</b><span>Busca robots en Supabase y agrégalos como participantes.</span></div></div>`;
            };

            /* =========================
               Players (respect N)
               ========================= */
            function syncParticipantsToN() {
                const N = state.tournament.n;
                if (state.players.length > N) {
                    state.players = state.players.slice(0, N);
                    renderPlayers();
                }
            }

            function addPlayer(compact) {
                syncTournamentFromForm();
                if (!compact?.i) return;

                if (state.players.some(p => p.i === compact.i)) return;

                const N = state.tournament.n;
                if (state.players.length >= N) {
                    alert(`Ya tienes ${N} participantes (N). Sube N o quita uno.`);
                    return;
                }
                state.players.push(compact);
            }

            function removePlayer(robotId) { state.players = state.players.filter(p => p.i !== robotId); }

            function renderPlayers() {
                const list = $("playersList");
                if (!state.players.length) {
                    list.innerHTML = `<div class="row"><div class="left"><b>Vacío</b><span>Agrega robots desde la búsqueda.</span></div></div>`;
                    return;
                }

                list.innerHTML = state.players.map((p, idx) => {
                    const info = robotLabel(p);
                    return `
              <div class="row">
                <div class="left">
                  <b>${esc((idx + 1) + ". " + info.name)}</b>
                  <span>${esc(info.sub)}</span>
                </div>
                <div class="right">
                  <button class="btn" data-up="${esc(p.i)}">↑</button>
                  <button class="btn" data-down="${esc(p.i)}">↓</button>
                  <button class="btn hot" data-remove="${esc(p.i)}">Quitar</button>
                </div>
              </div>
            `;
                }).join("");

                list.querySelectorAll("[data-remove]").forEach(b => {
                    b.addEventListener("click", () => {
                        removePlayer(b.getAttribute("data-remove"));
                        renderPlayers();
                    });
                });

                list.querySelectorAll("[data-up]").forEach(b => {
                    b.addEventListener("click", () => {
                        const id = b.getAttribute("data-up");
                        const i = state.players.findIndex(x => x.i === id);
                        if (i > 0) {
                            [state.players[i - 1], state.players[i]] = [state.players[i], state.players[i - 1]];
                            renderPlayers();
                        }
                    });
                });

                list.querySelectorAll("[data-down]").forEach(b => {
                    b.addEventListener("click", () => {
                        const id = b.getAttribute("data-down");
                        const i = state.players.findIndex(x => x.i === id);
                        if (i >= 0 && i < state.players.length - 1) {
                            [state.players[i + 1], state.players[i]] = [state.players[i], state.players[i + 1]];
                            renderPlayers();
                        }
                    });
                });
            }

            /* =========================
               View mode switch (groups/single)
               ========================= */
            function updateViewMode() {
                const f = state.tournament.format;
                $("viewTitle").textContent = (f === "groups") ? "Grupos + Fase final" : (f === "double" ? "Double (W/L)" : "Single Bracket");

                if (f === "groups") {
                    $("groupsArea").classList.remove("hidden");
                    $("bracketArea").classList.add("hidden");
                    $("mapWrap").classList.add("hidden");
                } else {
                    $("groupsArea").classList.add("hidden");
                    $("bracketArea").classList.remove("hidden");
                }
            }

            /* =========================================================
               Anti-team pairing (R1)
               ========================================================= */
            function pairAvoidSameTeam(players, size) {
                const slots = players.slice(0, size).map(p => p);
                while (slots.length < size) slots.push(null); // null=BYE

                const pool = slots.slice();
                const pairs = [];
                const used = new Set();

                function pickNext() {
                    for (let i = 0; i < pool.length; i++) if (!used.has(i)) return i;
                    return -1;
                }

                while (pairs.length < size / 2) {
                    const i = pickNext();
                    if (i === -1) break;
                    used.add(i);

                    const a = pool[i];
                    const aTeam = getTeam(a);
                    let bestJ = -1;
                    let bestScore = 1e9;

                    for (let j = 0; j < pool.length; j++) {
                        if (used.has(j)) continue;
                        const b = pool[j];
                        const bTeam = getTeam(b);

                        let score = 0;
                        if (a === null && b === null) score += 1000;
                        if (a !== null && b === null) score += 5;
                        if (a === null && b !== null) score += 5;
                        if (a !== null && b !== null && aTeam === bTeam) score += 50;

                        if (score < bestScore) { bestScore = score; bestJ = j; }
                    }

                    if (bestJ === -1) pairs.push([a, null]);
                    else { used.add(bestJ); pairs.push([a, pool[bestJ]]); }
                }

                return pairs;
            }

            function slotFromPlayer(p) {
                if (!p) return { id: "", name: "BYE", rid: "", team: "", compact: null, bye: true };
                return { id: p.i, name: p.n || "Robot", rid: p.i, team: getTeam(p), compact: p, bye: false };
            }
            function emptySlot() { return { id: "", name: "—", rid: "", team: "", compact: null, bye: false }; }
            function isBye(slot) { return slot?.name === "BYE" || slot?.bye; }

            /* =========================
               Bracket builders (BO3)
               ========================= */
            function buildSingleBracketBO3(players, N) {
                const size = nextPow2(N);
                const actual = players.slice(0, N);

                // R1 pairing anti-team
                const pairs = pairAvoidSameTeam(actual, size);

                const rounds = [];
                const r1 = pairs.map((pair, idx) => ({
                    id: `R1M${idx + 1}`,
                    a: slotFromPlayer(pair[0]),
                    b: slotFromPlayer(pair[1]),
                    wa: 0, wb: 0,
                    winner: null
                }));
                rounds.push(r1);

                const totalRounds = Math.log2(size);
                for (let r = 2; r <= totalRounds; r++) {
                    const prev = rounds[r - 2];
                    const matches = [];
                    for (let m = 0; m < prev.length; m += 2) {
                        matches.push({
                            id: `R${r}M${m / 2 + 1}`,
                            a: emptySlot(),
                            b: emptySlot(),
                            wa: 0, wb: 0,
                            winner: null
                        });
                    }
                    rounds.push(matches);
                }

                return { type: "single", size, rounds };
            }

            function autoAdvanceByesBO3(bracket) {
                const r1 = bracket.rounds[0];
                r1.forEach((m, mi) => {
                    if (isBye(m.a) && !isBye(m.b)) setWinnerBO3(bracket, 0, mi, "b");
                    else if (isBye(m.b) && !isBye(m.a)) setWinnerBO3(bracket, 0, mi, "a");
                });
            }

            function clearDownstreamBO3(bracket, fromRoundIndex, fromMatchIndex) {
                for (let r = fromRoundIndex; r < bracket.rounds.length; r++) {
                    const mi = (r === fromRoundIndex) ? fromMatchIndex : Math.floor(fromMatchIndex / Math.pow(2, (r - fromRoundIndex)));
                    const m = bracket.rounds[r][mi];
                    if (!m) continue;
                    m.winner = null;
                    m.wa = 0; m.wb = 0;
                }
            }

            function setWinnerBO3(bracket, ri, mi, side) {
                const m = bracket.rounds[ri][mi];
                m.winner = side;

                const nextRound = bracket.rounds[ri + 1];
                if (!nextRound) return;

                const targetMatchIndex = Math.floor(mi / 2);
                const targetSide = (mi % 2 === 0) ? "a" : "b";
                const winnerSlot = (m.winner === "a") ? m.a : (m.winner === "b" ? m.b : null);

                nextRound[targetMatchIndex][targetSide] = winnerSlot ? {
                    id: winnerSlot.id,
                    name: winnerSlot.name,
                    rid: winnerSlot.rid,
                    team: winnerSlot.team,
                    compact: winnerSlot.compact || null,
                    bye: !!winnerSlot.bye
                } : emptySlot();

                clearDownstreamBO3(bracket, ri + 1, targetMatchIndex);
            }

            function clearMatchBO3(bracket, ri, mi) {
                const m = bracket.rounds[ri][mi];
                m.winner = null; m.wa = 0; m.wb = 0;

                const nextRound = bracket.rounds[ri + 1];
                if (!nextRound) return;

                const targetMatchIndex = Math.floor(mi / 2);
                const targetSide = (mi % 2 === 0) ? "a" : "b";
                nextRound[targetMatchIndex][targetSide] = emptySlot();
                clearDownstreamBO3(bracket, ri + 1, targetMatchIndex);
            }

            function incWinBO3(bracket, ri, mi, side) {
                const m = bracket.rounds[ri][mi];
                if (side === "a") m.wa = clamp(m.wa + 1, 0, 2);
                if (side === "b") m.wb = clamp(m.wb + 1, 0, 2);

                if (m.wa >= 2) setWinnerBO3(bracket, ri, mi, "a");
                else if (m.wb >= 2) setWinnerBO3(bracket, ri, mi, "b");
            }

            /* =========================
               Render (columns) + mode
               ========================= */
            let VIEW_MODE = "organizer"; // organizer | competitor
            let VIEW_STYLE = "columns";  // columns | map

            function currentViewBracket() {
                if (!state.view) return null;
                if (state.view.type === "single") return state.view.bracket;
                if (state.view.type === "groups") return state.view.finalBracket;
                return null; // double demo no
            }

            function renderBracketColumns(bracket, mountId) {
                const wrap = document.getElementById(mountId);
                wrap.innerHTML = "";

                if (!bracket) {
                    wrap.innerHTML = `<div class="round"><div class="roundTitle"><span>Vista</span><span class="chip">—</span></div>
              <div class="match"><div class="hint">Genera para ver.</div></div></div>`;
                    return;
                }

                bracket.rounds.forEach((matches, ri) => {
                    const roundEl = document.createElement("div");
                    roundEl.className = "round";
                    const title = (ri === bracket.rounds.length - 1) ? "Final" : `Ronda ${ri + 1}`;
                    roundEl.innerHTML = `<div class="roundTitle"><span>${title}</span><span class="chip mono">${matches.length} matches</span></div>`;

                    matches.forEach((m, mi) => {
                        const matchEl = document.createElement("div");
                        matchEl.className = "match";

                        const aLine = `${[m.a.rid, m.a.team].filter(Boolean).join(" · ")}`;
                        const bLine = `${[m.b.rid, m.b.team].filter(Boolean).join(" · ")}`;

                        const scoreA = `${m.wa}/2`;
                        const scoreB = `${m.wb}/2`;

                        const organizerControls = (VIEW_MODE === "organizer") ? `
                <div class="btnRow" style="margin-top:10px">
                  <button class="btn primary" data-wina="1" data-ri="${ri}" data-mi="${mi}" data-mount="${mountId}">+win A</button>
                  <button class="btn primary" data-winb="1" data-ri="${ri}" data-mi="${mi}" data-mount="${mountId}">+win B</button>
                  <button class="btn" data-clear="1" data-ri="${ri}" data-mi="${mi}" data-mount="${mountId}">Reset</button>
                </div>
              ` : ``;

                        matchEl.innerHTML = `
                <div class="slot ${m.winner === "a" ? "win" : ""}">
                  <div class="name">
                    <b>${esc(m.a.name)}</b>
                    <span>${esc(aLine)}</span>
                  </div>
                  <div class="score">${esc(scoreA)}</div>
                </div>
                <div class="slot ${m.winner === "b" ? "win" : ""}">
                  <div class="name">
                    <b>${esc(m.b.name)}</b>
                    <span>${esc(bLine)}</span>
                  </div>
                  <div class="score">${esc(scoreB)}</div>
                </div>
                ${organizerControls}
              `;
                        roundEl.appendChild(matchEl);
                    });

                    wrap.appendChild(roundEl);
                });

                if (VIEW_MODE === "organizer") {
                    wrap.querySelectorAll("[data-wina]").forEach(btn => {
                        btn.addEventListener("click", () => {
                            const mount = btn.getAttribute("data-mount");
                            const ri = parseInt(btn.getAttribute("data-ri"), 10);
                            const mi = parseInt(btn.getAttribute("data-mi"), 10);

                            const b = (mount === "finalBracket") ? state.view.finalBracket : state.view.bracket;
                            if (!b) return;
                            incWinBO3(b, ri, mi, "a");
                            renderCurrent();
                        });
                    });

                    wrap.querySelectorAll("[data-winb]").forEach(btn => {
                        btn.addEventListener("click", () => {
                            const mount = btn.getAttribute("data-mount");
                            const ri = parseInt(btn.getAttribute("data-ri"), 10);
                            const mi = parseInt(btn.getAttribute("data-mi"), 10);

                            const b = (mount === "finalBracket") ? state.view.finalBracket : state.view.bracket;
                            if (!b) return;
                            incWinBO3(b, ri, mi, "b");
                            renderCurrent();
                        });
                    });

                    wrap.querySelectorAll("[data-clear]").forEach(btn => {
                        btn.addEventListener("click", () => {
                            const mount = btn.getAttribute("data-mount");
                            const ri = parseInt(btn.getAttribute("data-ri"), 10);
                            const mi = parseInt(btn.getAttribute("data-mi"), 10);

                            const b = (mount === "finalBracket") ? state.view.finalBracket : state.view.bracket;
                            if (!b) return;
                            clearMatchBO3(b, ri, mi);
                            renderCurrent();
                        });
                    });
                }
            }

            /* =========================
               Map SVG render
               ========================= */
            function renderBracketMapSVG(bracket, mountEl) {
                mountEl.innerHTML = "";
                if (!bracket) {
                    mountEl.innerHTML = `<div class="hint">Genera una llave para ver el mapa.</div>`;
                    return;
                }

                const colW = 320;
                const rowH = 86;
                const padX = 24, padY = 24;

                const rounds = bracket.rounds;
                const maxMatches = rounds[0].length;

                const nodes = [];
                for (let r = 0; r < rounds.length; r++) {
                    nodes[r] = [];
                    const matches = rounds[r];
                    const step = rowH * Math.pow(2, r);
                    for (let m = 0; m < matches.length; m++) {
                        const x = padX + r * colW;
                        const y = padY + m * step + (step / 2) - 28;
                        nodes[r][m] = { x, y, w: 280, h: 56 };
                    }
                }

                const svgW = padX * 2 + rounds.length * colW;
                const svgH = padY * 2 + maxMatches * rowH;

                const svgNS = "http://www.w3.org/2000/svg";
                const svg = document.createElementNS(svgNS, "svg");
                svg.setAttribute("width", "100%");
                svg.setAttribute("viewBox", `0 0 ${svgW} ${svgH}`);
                svg.style.display = "block";

                // connectors
                for (let r = 0; r < rounds.length - 1; r++) {
                    for (let m = 0; m < rounds[r].length; m++) {
                        const from = nodes[r][m];
                        const to = nodes[r + 1][Math.floor(m / 2)];

                        const x1 = from.x + from.w;
                        const y1 = from.y + from.h / 2;
                        const x2 = to.x;
                        const y2 = to.y + to.h / 2;

                        const path = document.createElementNS(svgNS, "path");
                        const midX = (x1 + x2) / 2;
                        path.setAttribute("d", `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
                        path.setAttribute("fill", "none");
                        path.setAttribute("stroke", "rgba(47,230,255,.20)");
                        path.setAttribute("stroke-width", "2");
                        svg.appendChild(path);
                    }
                }

                // nodes
                for (let r = 0; r < rounds.length; r++) {
                    for (let m = 0; m < rounds[r].length; m++) {
                        const match = rounds[r][m];
                        const n = nodes[r][m];

                        const rect = document.createElementNS(svgNS, "rect");
                        rect.setAttribute("x", n.x);
                        rect.setAttribute("y", n.y);
                        rect.setAttribute("rx", "14");
                        rect.setAttribute("width", n.w);
                        rect.setAttribute("height", n.h);
                        rect.setAttribute("fill", "rgba(0,0,0,.20)");
                        rect.setAttribute("stroke", "rgba(122,63,255,.28)");
                        rect.setAttribute("stroke-width", "2");
                        svg.appendChild(rect);

                        const textA = `${match.a.name} (${match.wa}/2)`;
                        const textB = `${match.b.name} (${match.wb}/2)`;

                        const t1 = document.createElementNS(svgNS, "text");
                        t1.setAttribute("x", n.x + 12);
                        t1.setAttribute("y", n.y + 22);
                        t1.setAttribute("fill", "rgba(234,240,255,.92)");
                        t1.setAttribute("font-size", "12");
                        t1.textContent = textA;
                        svg.appendChild(t1);

                        const t2 = document.createElementNS(svgNS, "text");
                        t2.setAttribute("x", n.x + 12);
                        t2.setAttribute("y", n.y + 44);
                        t2.setAttribute("fill", "rgba(234,240,255,.70)");
                        t2.setAttribute("font-size", "12");
                        t2.textContent = textB;
                        svg.appendChild(t2);

                        if (match.winner) {
                            const glow = document.createElementNS(svgNS, "rect");
                            glow.setAttribute("x", n.x - 2);
                            glow.setAttribute("y", n.y - 2);
                            glow.setAttribute("rx", "16");
                            glow.setAttribute("width", n.w + 4);
                            glow.setAttribute("height", n.h + 4);
                            glow.setAttribute("fill", "transparent");
                            glow.setAttribute("stroke", "rgba(47,230,255,.45)");
                            glow.setAttribute("stroke-width", "2");
                            svg.appendChild(glow);
                        }
                    }
                }

                mountEl.appendChild(svg);
            }

            function renderCurrent() {
                const t = state.tournament.format;

                // groups
                if (t === "groups") {
                    const b = state.view?.finalBracket || null;

                    if (VIEW_STYLE === "map") {
                        $("finalBracketArea").classList.add("hidden");
                        $("finalMapWrap").classList.remove("hidden");
                        renderBracketMapSVG(b, $("finalBracketMap"));
                    } else {
                        $("finalMapWrap").classList.add("hidden");
                        $("finalBracketArea").classList.remove("hidden");
                        renderBracketColumns(b, "finalBracket");
                    }
                    return;
                }

                // single
                if (t === "single") {
                    const b = state.view?.bracket || null;
                    if (VIEW_STYLE === "map") {
                        $("bracketArea").classList.add("hidden");
                        $("mapWrap").classList.remove("hidden");
                        renderBracketMapSVG(b, $("bracketMap"));
                    } else {
                        $("mapWrap").classList.add("hidden");
                        $("bracketArea").classList.remove("hidden");
                        renderBracketColumns(b, "bracket");
                    }
                    return;
                }

                // double: de momento respetamos tu demo de estructura (sin mapa)
                $("mapWrap").classList.add("hidden");
                $("bracketArea").classList.remove("hidden");
            }

            /* =========================
               Groups builder (demo) (igual)
               ========================= */
            function assignGroupsSnake(players, g) {
                const groups = Array.from({ length: g }, () => []);
                const ps = players.slice();
                let dir = 1, idx = 0;
                for (let i = 0; i < ps.length; i++) {
                    groups[idx].push(ps[i]);
                    if (dir === 1) {
                        idx++;
                        if (idx === g) { idx = g - 1; dir = -1; }
                    } else {
                        idx--;
                        if (idx < 0) { idx = 0; dir = 1; }
                    }
                }
                return groups;
            }

            function renderGroups(groups) {
                const grid = $("groupsGrid");
                grid.innerHTML = "";
                groups.forEach((arr, i) => {
                    const card = document.createElement("div");
                    card.className = "groupCard";
                    const title = document.createElement("h3");
                    title.innerHTML = `<span>Grupo ${String.fromCharCode(65 + i)}</span><span class="chip mono">${arr.length} robots</span>`;
                    card.appendChild(title);

                    arr.forEach((p) => {
                        const info = robotLabel(p);
                        const line = document.createElement("div");
                        line.className = "groupLine";
                        line.innerHTML = `<b>${esc(info.name)}</b><span>${esc([info.rid, p.t || ""].filter(Boolean).join(" · "))}</span>`;
                        card.appendChild(line);
                    });

                    grid.appendChild(card);
                });
            }

            /* =========================
               Double elimination (tu demo original)
               ========================= */
            function buildDoubleStructure(players, N) {
                const wb = buildSingleBracketBO3(players, N);
                const size = wb.size;
                const wbRounds = wb.rounds.length;

                const lbRoundsCount = 2 * (wbRounds - 1);
                const lb = {
                    type: "losers",
                    rounds: Array.from({ length: lbRoundsCount }, (_, i) => {
                        const approxMatches = Math.max(1, Math.floor(size / Math.pow(2, Math.floor((i + 2) / 2) + 1)));
                        return Array.from({ length: approxMatches }, (__, mi) => ({
                            id: `L${i + 1}M${mi + 1}`,
                            a: emptySlot(),
                            b: emptySlot(),
                            wa: 0, wb: 0,
                            winner: null
                        }));
                    })
                };

                const gf = {
                    type: "grand_final",
                    rounds: [[{
                        id: "GF",
                        a: { id: "", name: "Winners Champ", rid: "", team: "", compact: null, bye: false },
                        b: { id: "", name: "Losers Champ", rid: "", team: "", compact: null, bye: false },
                        wa: 0, wb: 0,
                        winner: null
                    }]]
                };

                return { type: "double", winners: wb, losers: lb, grandFinal: gf };
            }

            function renderBracketInlineBO3(bracket, container) {
                const rounds = bracket.rounds;
                rounds.forEach((matches, ri) => {
                    const roundEl = document.createElement("div");
                    roundEl.className = "round";
                    const title =
                        bracket.type === "losers" ? `LB R${ri + 1}` :
                            (ri === rounds.length - 1 ? "Final" : `Ronda ${ri + 1}`);

                    roundEl.innerHTML = `<div class="roundTitle"><span>${title}</span><span class="chip mono">${matches.length}</span></div>`;

                    matches.forEach((m) => {
                        const matchEl = document.createElement("div");
                        matchEl.className = "match";
                        matchEl.innerHTML = `
                <div class="slot">
                  <div class="name"><b>${esc(m.a.name)}</b><span>${esc([m.a.rid, m.a.team].filter(Boolean).join(" · "))}</span></div>
                  <div class="score">${esc(m.wa || 0)}/2</div>
                </div>
                <div class="slot">
                  <div class="name"><b>${esc(m.b.name)}</b><span>${esc([m.b.rid, m.b.team].filter(Boolean).join(" · "))}</span></div>
                  <div class="score">${esc(m.wb || 0)}/2</div>
                </div>
              `;
                        roundEl.appendChild(matchEl);
                    });

                    container.appendChild(roundEl);
                });
            }

            /* =========================
               Generate view
               ========================= */
            function clearView() {
                state.view = null;
                $("bracket").innerHTML = "";
                $("finalBracket").innerHTML = "";
                $("groupsGrid").innerHTML = "";
                $("bracketMap").innerHTML = "";
                $("finalBracketMap").innerHTML = "";

                $("mapWrap").classList.add("hidden");
                $("finalMapWrap").classList.add("hidden");
                $("finalBracketArea").classList.remove("hidden");
                $("bracketArea").classList.remove("hidden");

                renderBracketColumns(null, "bracket");
            }

            function generate() {
                syncTournamentFromForm();
                syncParticipantsToN();

                const t = state.tournament;
                const N = t.n;

                if (state.players.length < 2) {
                    alert("Agrega al menos 2 participantes.");
                    return;
                }

                if (state.players.length > N) {
                    alert(`Tienes más de N=${N}. Quita participantes o sube N.`);
                    return;
                }

                const fmt = t.format;

                // default: columnas + organizador
                VIEW_STYLE = "columns";
                VIEW_MODE = "organizer";
                $("btnMode").textContent = "Modo: Organizador";

                if (fmt === "single") {
                    const bracket = buildSingleBracketBO3(state.players, N);
                    autoAdvanceByesBO3(bracket);
                    state.view = { type: "single", bracket };
                    renderCurrent();
                }

                if (fmt === "groups") {
                    const g = Math.min(t.groups, Math.max(2, state.players.length));
                    const adv = Math.max(1, t.adv);

                    const groups = assignGroupsSnake(state.players, g);
                    renderGroups(groups);

                    let qualifiers = [];
                    groups.forEach(arr => { qualifiers = qualifiers.concat(arr.slice(0, adv)); });

                    const finalN = Math.max(2, qualifiers.length);
                    const bracket = buildSingleBracketBO3(qualifiers, finalN);
                    autoAdvanceByesBO3(bracket);

                    state.view = { type: "groups", groups, qualifiers, finalBracket: bracket };
                    renderCurrent();
                }

                if (fmt === "double") {
                    const dbl = buildDoubleStructure(state.players, N);
                    state.view = { type: "double", dbl };

                    // Render all inside main bracket columns (demo)
                    const mount = $("bracket");
                    mount.innerHTML = "";

                    const winnersLabel = document.createElement("div");
                    winnersLabel.className = "round";
                    winnersLabel.innerHTML = `<div class="roundTitle"><span>Winners Bracket</span><span class="chip mono">${dbl.winners.size}</span></div>`;
                    mount.appendChild(winnersLabel);

                    renderBracketInlineBO3(dbl.winners, mount);

                    const losersLabel = document.createElement("div");
                    losersLabel.className = "round";
                    losersLabel.innerHTML = `<div class="roundTitle"><span>Losers Bracket</span><span class="chip mono">${dbl.losers.rounds.length} rounds</span></div>
              <div class="match"><div class="hint">Estructura demo: falta conectar derrotados → LB.</div></div>`;
                    mount.appendChild(losersLabel);

                    renderBracketInlineBO3(dbl.losers, mount);

                    const gfLabel = document.createElement("div");
                    gfLabel.className = "round";
                    gfLabel.innerHTML = `<div class="roundTitle"><span>Grand Final</span><span class="chip mono">GF</span></div>`;
                    mount.appendChild(gfLabel);

                    renderBracketInlineBO3(dbl.grandFinal, mount);

                    // ocultar mapa
                    $("mapWrap").classList.add("hidden");
                    $("bracketArea").classList.remove("hidden");
                }
            }

            /* =========================
               Buttons
               ========================= */
            $("btnGenerate").onclick = generate;
            $("btnShuffle").onclick = () => { state.players = shuffleArray(state.players); renderPlayers(); };
            $("btnClearView").onclick = clearView;

            $("btnViewColumns").onclick = () => { VIEW_STYLE = "columns"; renderCurrent(); };
            $("btnViewMap").onclick = () => {
                VIEW_STYLE = "map";
                // en mapa normalmente quieres vista competidor
                if (VIEW_MODE !== "competitor") {
                    VIEW_MODE = "competitor";
                    $("btnMode").textContent = "Modo: Competidor";
                }
                renderCurrent();
            };
            $("btnMode").onclick = () => {
                VIEW_MODE = (VIEW_MODE === "organizer") ? "competitor" : "organizer";
                $("btnMode").textContent = (VIEW_MODE === "organizer") ? "Modo: Organizador" : "Modo: Competidor";
                // si estás en mapa, deja; si en columnas, cambia controles
                renderCurrent();
            };

            $("btnNew").onclick = () => {
                if (!confirm("¿Nuevo torneo? Se borrará el estado actual (no la DB).")) return;
                state.tournament = { name: "", category: "Mini Sumo Autónomo Profesional", venue: "", date: "", format: "single", n: 8, groups: 4, adv: 2 };
                state.players = [];
                clearView();

                $("t_name").value = "";
                $("t_category").value = "Mini Sumo Autónomo Profesional";
                $("t_venue").value = "";
                $("t_date").value = "";
                $("t_format").value = "single";
                $("t_n").value = "8";
                $("t_groups").value = "4";
                $("t_adv").value = "2";

                $("r_search").value = "";
                $("searchList").innerHTML = `<div class="row"><div class="left"><b>Tip</b><span>Busca robots en Supabase y agrégalos como participantes.</span></div></div>`;
                renderPlayers();
                setChips();
                updateViewMode();
            };

            $("btnReset").onclick = () => location.reload();

            /* =========================
               Save/Load Local (igual)
               ========================= */
            const LOCAL_KEY = "apex_tournament_flex_demo_v2_bo3_map";

            $("btnSaveLocal").onclick = () => {
                syncTournamentFromForm();
                const payload = { tournament: state.tournament, players: state.players, view: state.view, VIEW_MODE, VIEW_STYLE };
                localStorage.setItem(LOCAL_KEY, JSON.stringify(payload));
                $("tournStatus").textContent = "· guardado local ✅";
                setTimeout(() => $("tournStatus").textContent = "", 1400);
            };

            $("btnLoadLocal").onclick = () => {
                const raw = localStorage.getItem(LOCAL_KEY);
                if (!raw) return alert("No hay guardado local.");
                try {
                    const payload = JSON.parse(raw);
                    state.tournament = payload.tournament || state.tournament;
                    state.players = payload.players || [];
                    state.view = payload.view || null;
                    VIEW_MODE = payload.VIEW_MODE || "organizer";
                    VIEW_STYLE = payload.VIEW_STYLE || "columns";
                    $("btnMode").textContent = (VIEW_MODE === "organizer") ? "Modo: Organizador" : "Modo: Competidor";

                    $("t_name").value = state.tournament.name || "";
                    $("t_category").value = state.tournament.category || "Mini Sumo Autónomo Profesional";
                    $("t_venue").value = state.tournament.venue || "";
                    $("t_date").value = state.tournament.date || "";
                    $("t_format").value = state.tournament.format || "single";
                    $("t_n").value = String(state.tournament.n || 8);
                    $("t_groups").value = String(state.tournament.groups || 4);
                    $("t_adv").value = String(state.tournament.adv || 2);

                    setChips();
                    updateViewMode();
                    renderPlayers();

                    // re-render view
                    if (state.view?.type === "single" || state.view?.type === "groups") {
                        renderCurrent();
                    } else if (state.view?.type === "double") {
                        // reconstruye demo
                        clearView();
                        generate();
                    } else {
                        clearView();
                    }
                } catch (e) {
                    alert("No pude abrir guardado local.");
                }
            };

            /* =========================
               Boot
               ========================= */
            function boot() {
                syncTournamentFromForm();
                renderPlayers();
                clearView();
            }
            boot();
        })();
    </script>

</body>

</html>